<!DOCTYPE html>
<html>
<head>
  <title>Forest City - Water Line Viewer</title>
	<meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.68.0/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="./css/leaflet-panel-layers.min.css" />
  <link rel="stylesheet" href="./css/leaflet-search.css" />

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
  <script src="./js/leaflet.ajax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.68.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>
  <script src="./js/leaflet-panel-layers.min.js"></script>
  <script src="./js/leaflet-search.js"></script>

  <style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 600px;
			height: 400px;
		}
	</style>

	<style>body { padding: 0; margin: 0; } #map { height: 100%; width: 100vw; }</style>
</head>

<body>
<div id='map'></div>



  <script>
    var map = L.map('map', {
    			    //layers: [googleSat, sewerLines, waterLines]
    		}).setView([35.339744, -81.872195], 18);

    // basemaps, added in L.control.panellayers  //

    var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
          maxZoom: 22,
          subdomains:['mt0','mt1','mt2','mt3']
    });

    var mapboxStreets = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v9/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZGJoYXJyaXM5MiIsImEiOiJjamo1dm5hOGswOHMzM2tubm12OGhjdXdzIn0.MXeiHXd9767rehYZ2fBVHQ', {
	        maxZoom: 22,
	        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	        maxZoom: 22,
	        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    var googleHybrid = L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}&s=Ga',{
          maxZoom: 22,
          subdomains:['mt0','mt1','mt2','mt3']
    });
    // end basemaps //

    // feature styles, then layers //
    var waterStyle = {
        "color": "#487bb6",
        "weight": 3,
        "opacity": 1
    };

    var sewerStyle = {
        "color": "#33a02c",
        "weight": 3,
        "opacity": 1
    };

    var meterStyle = {
      radius: 3,
      fillColor: "#ff7800",
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    };

    var valveStyle = {
      radius: 3,
      fillColor: "#f3a6b2",
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    };

    var addressStyle = {
      radius: 0,
      fillColor: "#f3a6b2",
      color: "#000",
      weight: 1,
      opacity: 0,
      fillOpacity: 0
    };

    var waterLines = new L.GeoJSON.AJAX("data/waterLines.geojson", {
      style: waterStyle,
      onEachFeature: function (feature, layer) {
        layer.bindPopup(
          '<h3>' + feature.properties.DIAMETER + ' ' + feature.properties.MATERIAL + '</h3>'
      )},
    });

    var sewerLines = new L.GeoJSON.AJAX("data/sewerLines.geojson", {
      style: sewerStyle,
      onEachFeature: function (feature, layer) {
        layer.bindPopup(
          '<h3>' + feature.properties.Diameter + '</h3>'
      )},
    });

    var meters = new L.GeoJSON.AJAX("data/meters.geojson", {
      pointToLayer: function (feature, latlng) {
       return L.circleMarker(latlng, meterStyle);
     },
      onEachFeature: function (feature, layer) {
        layer.bindPopup(
          '<h3>' + feature.properties.description + '</h3>'
      )},
    });

    var valves = new L.GeoJSON.AJAX("data/valves.geojson", {
      pointToLayer: function (feature, latlng) {
       return L.circleMarker(latlng, valveStyle);
     },
      onEachFeature: function (feature, layer) {
        layer.bindPopup(
          '<h3>' + feature.properties.FEATURE + '</h3>'
      )},
    });

    // var overlays = {
    //   "Water Lines": waterLines,
    //   "Sewer Lines": sewerLines,
    //   "Water Meter": meters,
    //   "Water Valve": valves
		// };

    var baseLayers = [
        	{
        		name: "Google Aerial",
            active: true,
        		layer: googleSat
        	},
        	{
        		group: "Road Layers",
        		collapsed: true,
        		layers: [
        			{
        				name: "Mapbox Streets",
        				layer: mapboxStreets
        			},
        			{
        				name: "Google Hybrid",
        				layer: googleHybrid
        			}
        		]
        	}
        ];

    var overLayers = [
      	{
      		group: "Lines",
      		layers: [
      			{
      				active: true,
      				name: "Water",
      				layer: waterLines
      			},
      			{
      				active: false,
      				name: "Sewer",
      				layer: sewerLines
      			},
            // {
      			// 	active: false,
      			// 	name: "Electric",
      			// 	layer: electricLines
      			// },
      		]
      	},
      	{
      		group: "Points",
      		layers: [
      			{
      				active: false,
      				name: "Meters",
      				layer: meters
      			},
      			{
      				active: false,
      				name: "Valves",
      				layer: valves
      			}
      		]
      	}
      ];

    var panelLayers = new L.Control.PanelLayers(baseLayers, overLayers, {
    	//compact: true,
    	//collapsed: true,
    	    collapsibleGroups: true
      });

    map.addControl(panelLayers);
    //L.control.layers(overlays).addTo(map);
    //L.control.locate().addTo(map);

    var addresses = new L.GeoJSON.AJAX("data/address.geojson", {
      pointToLayer: function (feature, latlng) {
       return L.circleMarker(latlng, addressStyle);
      },
    }).addTo(map);

    var searchControl = new L.Control.Search({
		      layer: addresses,
		      propertyName: 'full_addre',
		      marker: false,
		      moveToLocation: function(latlng, title, map) {
			      //map.fitBounds( latlng.layer.getBounds() );
			      var zoom = map.getBoundsZoom(latlng.layer.getBounds());
  			    map.setView(latlng, zoom); // access the zoom
		      }
	  });

    searchControl.on('search:locationfound', function(e) {

		//console.log('search:locationfound', );

		//map.removeLayer(this._markerSearch)

		  e.layer.setStyle({fillColor: '#3f0', color: '#0f0'});
		  if(e.layer._popup)
		    e.layer.openPopup();

	  }).on('search:collapsed', function(e) {

		  featuresLayer.eachLayer(function(layer) {	//restore feature color
			  featuresLayer.resetStyle(layer);
		  });
	  });

    map.addControl(searchControl);



  </script>
</body>
</html>
